<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DM Copilot Admin</title>
  <style>
    :root {
      color-scheme: dark;
      --bg: #0f1117;
      --panel: #171a22;
      --panel-2: #1f2430;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #2a3140;
      --accent: #7dd3fc;
      --accent-2: #a78bfa;
      --danger: #f87171;
      --success: #34d399;
      --warning: #fbbf24;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    header {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
      justify-content: space-between;
      padding: 20px 28px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(135deg, #151a28 0%, #141722 100%);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    header h1 {
      margin: 0;
      font-size: 20px;
      letter-spacing: 0.4px;
    }

    .header-controls {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .control {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 12px;
      color: var(--muted);
    }

    .control input,
    .control select,
    .control textarea {
      background: var(--panel);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 8px;
      min-width: 180px;
    }

    .control input[type="checkbox"] {
      min-width: auto;
    }

    nav {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      padding: 16px 24px;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
    }

    nav button {
      border: 1px solid var(--border);
      background: var(--panel-2);
      color: var(--text);
      padding: 8px 14px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 600;
    }

    nav button.active {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #0b1120;
      border-color: transparent;
    }

    main {
      padding: 24px;
      display: grid;
      gap: 20px;
    }

    .tab {
      display: none;
      gap: 20px;
    }

    .tab.active {
      display: grid;
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-width: 0;
    }

    .panel h2 {
      margin: 0 0 6px;
      font-size: 16px;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    .row > * {
      flex: 1 1 auto;
    }

    button.primary {
      background: var(--accent);
      color: #0b1120;
      border: none;
      padding: 10px 16px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
    }

    button.secondary {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 10px 16px;
      border-radius: 10px;
      cursor: pointer;
    }

    button.danger {
      background: var(--danger);
      color: #0b1120;
      border: none;
      padding: 10px 16px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
    }

    .status {
      font-size: 13px;
      padding: 10px 14px;
      border-radius: 10px;
      background: var(--panel-2);
      border: 1px solid var(--border);
      color: var(--muted);
    }

    .status.ok {
      color: var(--success);
    }

    .status.warn {
      color: var(--warning);
    }

    .status.err {
      color: var(--danger);
    }

    textarea {
      min-height: 120px;
      resize: vertical;
    }

    pre {
      background: #0b0f1a;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      overflow: auto;
      max-height: 300px;
      color: #d1d5db;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
    }

    .log-output {
      white-space: pre-wrap;
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, monospace;
      font-size: 12px;
      max-height: 360px;
      overflow: auto;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: var(--panel-2);
      border: 1px solid var(--border);
      color: var(--muted);
      font-size: 12px;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>DM Copilot Admin</h1>
      <div class="pill" id="connectionStatus">Disconnected</div>
    </div>
    <div class="header-controls">
      <label class="control">
        Web Token
        <input id="tokenInput" type="password" placeholder="x-web-token" />
      </label>
      <label class="control">
        User ID
        <input id="userIdInput" type="text" placeholder="web" />
      </label>
      <label class="control">
        Auto Refresh
        <select id="refreshSelect">
          <option value="off">Off</option>
          <option value="3000">3s</option>
          <option value="6000">6s</option>
          <option value="10000">10s</option>
        </select>
      </label>
      <button class="primary" id="connectBtn">Connect</button>
    </div>
  </header>

  <nav id="tabNav">
    <button data-tab="dashboard" class="active">Dashboard</button>
    <button data-tab="girls">Girls</button>
    <button data-tab="messages">Messages</button>
    <button data-tab="context">Context</button>
    <button data-tab="notes">Notes</button>
    <button data-tab="stats">Stats</button>
    <button data-tab="data">Data</button>
    <button data-tab="settings">Settings</button>
    <button data-tab="logs">Logs</button>
    <button data-tab="chat">Chat</button>
  </nav>

  <main>
    <section id="tab-dashboard" class="tab active">
      <div class="panel">
        <h2>Status</h2>
        <div class="status" id="statusSummary">Awaiting connection.</div>
        <div class="grid-2">
          <div>
            <strong>Active Girl</strong>
            <div id="statusGirl">-</div>
          </div>
          <div>
            <strong>Stage</strong>
            <div id="statusStage">-</div>
          </div>
          <div>
            <strong>Learning</strong>
            <div id="statusLearning">-</div>
          </div>
          <div>
            <strong>Settings</strong>
            <div id="statusSettings">-</div>
          </div>
        </div>
        <div class="row">
          <button class="primary" id="refreshStatusBtn">Refresh Status</button>
          <button class="secondary" id="saveBtn">Save Store</button>
          <button class="secondary" id="reloadBtn">Reload Store</button>
          <button class="danger" id="panicBtn">Panic</button>
        </div>
      </div>
      <div class="panel">
        <h2>Users</h2>
        <div class="row">
          <button class="primary" id="loadUsersBtn">Load Users</button>
        </div>
        <pre id="usersOutput">No data.</pre>
      </div>
    </section>

    <section id="tab-girls" class="tab">
      <div class="panel">
        <h2>Girls</h2>
        <div class="row">
          <button class="primary" id="loadGirlsBtn">Load Girls</button>
          <label class="control">
            Active Girl
            <select id="activeGirlSelect"></select>
          </label>
          <button class="secondary" id="setActiveGirlBtn">Set Active</button>
        </div>
        <pre id="girlsOutput">No data.</pre>
      </div>
    </section>

    <section id="tab-messages" class="tab">
      <div class="panel">
        <h2>Generate Replies</h2>
        <label class="control">
          Her Message
          <textarea id="herMessageInput" placeholder="Paste her message..."></textarea>
        </label>
        <div class="row">
          <button class="primary" id="generateBtn">Generate</button>
          <button class="secondary" id="analyzeBtn">Analyze Last</button>
        </div>
        <pre id="suggestionsOutput">No suggestions yet.</pre>
        <div class="row">
          <button class="secondary" data-commit="best">Commit Best</button>
          <button class="secondary" data-commit="alt1">Commit Alt1</button>
          <button class="secondary" data-commit="alt2">Commit Alt2</button>
          <button class="secondary" data-commit="alt3">Commit Alt3</button>
        </div>
        <label class="control">
          Manual Commit
          <textarea id="commitTextInput" placeholder="Manually pick/override a reply"></textarea>
        </label>
        <button class="secondary" id="commitManualBtn">Commit Manual</button>
      </div>
      <div class="panel">
        <h2>Tweaks & Outcome</h2>
        <div class="row">
          <button class="secondary" data-tweak="short">Shorter</button>
          <button class="secondary" data-tweak="funny">Funner</button>
          <button class="secondary" data-tweak="bolder">Bolder</button>
          <button class="secondary" data-tweak="invite">Invite</button>
          <button class="secondary" data-tweak="why">Why</button>
        </div>
        <div class="row">
          <button class="secondary" data-outcome="replied">Replied</button>
          <button class="secondary" data-outcome="strongReplied">Strong Replied</button>
          <button class="secondary" data-outcome="datePlanned">Date Planned</button>
          <button class="secondary" data-outcome="date">Date</button>
          <button class="secondary" data-outcome="ghost">Ghost</button>
        </div>
        <pre id="messageMetaOutput">No metadata.</pre>
      </div>
    </section>

    <section id="tab-context" class="tab">
      <div class="panel">
        <h2>Context</h2>
        <textarea id="contextInput" placeholder="Current context"></textarea>
        <div class="row">
          <button class="primary" id="loadContextBtn">Load Context</button>
          <button class="secondary" id="saveContextBtn">Save Context</button>
          <button class="secondary" id="resetContextBtn">Reset Context</button>
        </div>
      </div>
    </section>

    <section id="tab-notes" class="tab">
      <div class="panel">
        <h2>Notes</h2>
        <textarea id="noteInput" placeholder="Add note"></textarea>
        <div class="row">
          <button class="primary" id="addNoteBtn">Add Note</button>
          <button class="secondary" id="loadNotesBtn">Load Notes</button>
        </div>
        <pre id="notesOutput">No notes.</pre>
      </div>
    </section>

    <section id="tab-stats" class="tab">
      <div class="panel">
        <h2>Stats</h2>
        <div class="row">
          <button class="primary" id="loadStatsBtn">Load Stats</button>
          <button class="secondary" id="resetStatsBtn">Reset Stats</button>
        </div>
        <pre id="statsOutput">No stats.</pre>
      </div>
    </section>

    <section id="tab-data" class="tab">
      <div class="panel">
        <h2>Data Store</h2>
        <textarea id="dataEditor" placeholder="JSON data"></textarea>
        <div class="row">
          <button class="primary" id="loadDataBtn">Load Data</button>
          <button class="secondary" id="saveDataBtn">Save Data</button>
          <button class="secondary" id="exportDataBtn">Export JSON</button>
          <button class="secondary" id="backupBtn">Create Backup</button>
        </div>
        <pre id="backupOutput">No backups yet.</pre>
      </div>
    </section>

    <section id="tab-settings" class="tab">
      <div class="panel">
        <h2>Settings</h2>
        <div class="grid-2">
          <label class="control">
            Autopick
            <select id="autopickSelect">
              <option value="true">On</option>
              <option value="false">Off</option>
            </select>
          </label>
          <label class="control">
            Pacing
            <select id="pacingSelect">
              <option value="warm">Warm</option>
              <option value="fast">Fast</option>
            </select>
          </label>
          <label class="control">
            Autoghost Hours
            <input id="autoghostInput" type="number" min="0" max="720" step="1" />
          </label>
          <label class="control">
            Learning Enabled
            <select id="learningSelect">
              <option value="true">On</option>
              <option value="false">Off</option>
            </select>
          </label>
          <label class="control">
            Learning Debug
            <select id="learnDebugSelect">
              <option value="true">On</option>
              <option value="false">Off</option>
            </select>
          </label>
        </div>
        <div class="row">
          <button class="primary" id="saveSettingsBtn">Save Settings</button>
          <button class="secondary" id="resetLearningBtn">Reset Learning</button>
        </div>
        <div class="panel">
          <h2>Tune Weights</h2>
          <div class="row">
            <input id="tuneKeyInput" type="text" placeholder="weight key (warmth, humor...)" />
            <input id="tuneValueInput" type="number" step="0.05" min="-1" max="1" placeholder="value" />
            <button class="secondary" id="tuneBtn">Apply</button>
          </div>
          <pre id="tuneOutput">No tuning yet.</pre>
        </div>
      </div>
    </section>

    <section id="tab-logs" class="tab">
      <div class="panel">
        <h2>Logs</h2>
        <div class="row">
          <label class="control">
            Lines
            <input id="logLinesInput" type="number" min="50" max="2000" value="200" />
          </label>
          <button class="primary" id="loadLogsBtn">Load Logs</button>
        </div>
        <div class="grid-2">
          <div>
            <h3>stdout</h3>
            <pre id="logsOut" class="log-output">No logs.</pre>
          </div>
          <div>
            <h3>stderr</h3>
            <pre id="logsErr" class="log-output">No logs.</pre>
          </div>
        </div>
      </div>
    </section>

    <section id="tab-chat" class="tab">
      <div class="panel">
        <h2>Chat Tester</h2>
        <label class="control">
          System Prompt
          <textarea id="chatSystemInput" placeholder="System prompt"></textarea>
        </label>
        <label class="control">
          Message
          <textarea id="chatMessageInput" placeholder="User message"></textarea>
        </label>
        <div class="grid-3">
          <label class="control">
            Temperature
            <input id="chatTempInput" type="number" step="0.1" min="0" max="2" value="0.6" />
          </label>
          <label class="control">
            Max Output Tokens
            <input id="chatTokensInput" type="number" min="64" max="2048" value="256" />
          </label>
        </div>
        <button class="primary" id="chatSendBtn">Run Chat</button>
        <pre id="chatOutput">No output.</pre>
      </div>
    </section>
  </main>

  <script>
    const state = {
      token: localStorage.getItem('webToken') || '',
      userId: localStorage.getItem('userId') || 'web',
      refreshMs: localStorage.getItem('refreshMs') || 'off',
      refreshTimer: null,
    };

    const tokenInput = document.getElementById('tokenInput');
    const userIdInput = document.getElementById('userIdInput');
    const refreshSelect = document.getElementById('refreshSelect');
    const connectionStatus = document.getElementById('connectionStatus');
    const statusSummary = document.getElementById('statusSummary');
    const statusGirl = document.getElementById('statusGirl');
    const statusStage = document.getElementById('statusStage');
    const statusLearning = document.getElementById('statusLearning');
    const statusSettings = document.getElementById('statusSettings');

    tokenInput.value = state.token;
    userIdInput.value = state.userId;
    refreshSelect.value = state.refreshMs;

    function setStatus(text, tone = '') {
      statusSummary.textContent = text;
      statusSummary.className = `status ${tone}`.trim();
    }

    function setConnection(text, tone = '') {
      connectionStatus.textContent = text;
      connectionStatus.className = `pill ${tone}`.trim();
    }

    function headers() {
      return {
        'Content-Type': 'application/json',
        'x-web-token': state.token,
        'x-user-id': state.userId,
      };
    }

    async function apiFetch(path, options = {}) {
      const response = await fetch(path, {
        ...options,
        headers: { ...headers(), ...(options.headers || {}) },
      });
      const contentType = response.headers.get('content-type') || '';
      let payload;
      if (contentType.includes('application/json')) {
        payload = await response.json();
      } else {
        payload = await response.text();
      }
      if (!response.ok) {
        const message = payload?.error || payload || 'Request failed';
        throw new Error(message);
      }
      return payload;
    }

    async function refreshStatus() {
      try {
        const data = await apiFetch('/api/status');
        statusGirl.textContent = data.activeGirl || '-';
        statusStage.textContent = data.stage || '-';
        statusLearning.textContent = `enabled=${data.learning?.enabled} debug=${data.learning?.debug}`;
        statusSettings.textContent = JSON.stringify(data.settings || {});
        setStatus('Connected', 'ok');
        setConnection('Connected', 'ok');
        hydrateSettings(data);
      } catch (error) {
        setStatus(error.message, 'err');
        setConnection('Disconnected', 'warn');
      }
    }

    function hydrateSettings(data) {
      if (!data) return;
      document.getElementById('autopickSelect').value = String(Boolean(data.settings?.autopick));
      document.getElementById('pacingSelect').value = data.settings?.pacing || 'warm';
      document.getElementById('autoghostInput').value = data.settings?.autoghostHours ?? 0;
      document.getElementById('learningSelect').value = String(Boolean(data.learning?.enabled));
      document.getElementById('learnDebugSelect').value = String(Boolean(data.learning?.debug));
    }

    function savePrefs() {
      state.token = tokenInput.value.trim();
      state.userId = userIdInput.value.trim() || 'web';
      state.refreshMs = refreshSelect.value;
      localStorage.setItem('webToken', state.token);
      localStorage.setItem('userId', state.userId);
      localStorage.setItem('refreshMs', state.refreshMs);
    }

    function updateRefreshTimer() {
      if (state.refreshTimer) {
        clearInterval(state.refreshTimer);
        state.refreshTimer = null;
      }
      if (state.refreshMs !== 'off') {
        const interval = Number(state.refreshMs);
        if (Number.isFinite(interval) && interval > 0) {
          state.refreshTimer = setInterval(() => {
            refreshStatus();
            loadLogs();
          }, interval);
        }
      }
    }

    document.getElementById('connectBtn').addEventListener('click', async () => {
      savePrefs();
      updateRefreshTimer();
      await refreshStatus();
    });

    refreshSelect.addEventListener('change', () => {
      savePrefs();
      updateRefreshTimer();
    });

    document.getElementById('refreshStatusBtn').addEventListener('click', refreshStatus);
    document.getElementById('saveBtn').addEventListener('click', async () => {
      try {
        await apiFetch('/api/save', { method: 'POST', body: '{}' });
        setStatus('Store saved', 'ok');
      } catch (error) {
        setStatus(error.message, 'err');
      }
    });
    document.getElementById('reloadBtn').addEventListener('click', async () => {
      try {
        await apiFetch('/api/reload', { method: 'POST', body: '{}' });
        setStatus('Store reloaded', 'ok');
      } catch (error) {
        setStatus(error.message, 'err');
      }
    });
    document.getElementById('panicBtn').addEventListener('click', async () => {
      try {
        await apiFetch('/api/panic', { method: 'POST', body: '{}' });
        setStatus('Panic acknowledged', 'warn');
      } catch (error) {
        setStatus(error.message, 'err');
      }
    });

    document.getElementById('loadUsersBtn').addEventListener('click', async () => {
      const output = document.getElementById('usersOutput');
      try {
        const data = await apiFetch('/api/users');
        output.textContent = JSON.stringify(data, null, 2);
      } catch (error) {
        output.textContent = error.message;
      }
    });

    document.getElementById('loadGirlsBtn').addEventListener('click', async () => {
      const output = document.getElementById('girlsOutput');
      const select = document.getElementById('activeGirlSelect');
      try {
        const data = await apiFetch('/api/girls');
        output.textContent = JSON.stringify(data, null, 2);
        select.innerHTML = '';
        data.girls.forEach((name) => {
          const option = document.createElement('option');
          option.value = name;
          option.textContent = name;
          if (name === data.active) option.selected = true;
          select.appendChild(option);
        });
      } catch (error) {
        output.textContent = error.message;
      }
    });

    document.getElementById('setActiveGirlBtn').addEventListener('click', async () => {
      const select = document.getElementById('activeGirlSelect');
      try {
        const data = await apiFetch('/api/girls/active', {
          method: 'POST',
          body: JSON.stringify({ name: select.value }),
        });
        document.getElementById('girlsOutput').textContent = JSON.stringify(data, null, 2);
        await refreshStatus();
      } catch (error) {
        document.getElementById('girlsOutput').textContent = error.message;
      }
    });

    document.getElementById('generateBtn').addEventListener('click', async () => {
      const message = document.getElementById('herMessageInput').value;
      const output = document.getElementById('suggestionsOutput');
      try {
        const data = await apiFetch('/api/message/generate', {
          method: 'POST',
          body: JSON.stringify({ text: message }),
        });
        output.textContent = data.suggestions || JSON.stringify(data, null, 2);
        document.getElementById('messageMetaOutput').textContent = JSON.stringify(data, null, 2);
        await refreshStatus();
      } catch (error) {
        output.textContent = error.message;
      }
    });

    document.getElementById('analyzeBtn').addEventListener('click', async () => {
      const output = document.getElementById('messageMetaOutput');
      try {
        const data = await apiFetch('/api/message/analyzeLast', { method: 'POST', body: '{}' });
        output.textContent = JSON.stringify(data, null, 2);
      } catch (error) {
        output.textContent = error.message;
      }
    });

    document.querySelectorAll('[data-commit]').forEach((btn) => {
      btn.addEventListener('click', async () => {
        const which = btn.dataset.commit;
        try {
          const data = await apiFetch('/api/message/commit', {
            method: 'POST',
            body: JSON.stringify({ which }),
          });
          document.getElementById('messageMetaOutput').textContent = JSON.stringify(data, null, 2);
          await refreshStatus();
        } catch (error) {
          document.getElementById('messageMetaOutput').textContent = error.message;
        }
      });
    });

    document.getElementById('commitManualBtn').addEventListener('click', async () => {
      const text = document.getElementById('commitTextInput').value;
      try {
        const data = await apiFetch('/api/message/commit', {
          method: 'POST',
          body: JSON.stringify({ text }),
        });
        document.getElementById('messageMetaOutput').textContent = JSON.stringify(data, null, 2);
        await refreshStatus();
      } catch (error) {
        document.getElementById('messageMetaOutput').textContent = error.message;
      }
    });

    document.querySelectorAll('[data-tweak]').forEach((btn) => {
      btn.addEventListener('click', async () => {
        const type = btn.dataset.tweak;
        try {
          const data = await apiFetch('/api/message/tweak', {
            method: 'POST',
            body: JSON.stringify({ type }),
          });
          document.getElementById('suggestionsOutput').textContent = data.suggestions || JSON.stringify(data, null, 2);
          document.getElementById('messageMetaOutput').textContent = JSON.stringify(data, null, 2);
          await refreshStatus();
        } catch (error) {
          document.getElementById('messageMetaOutput').textContent = error.message;
        }
      });
    });

    document.querySelectorAll('[data-outcome]').forEach((btn) => {
      btn.addEventListener('click', async () => {
        const outcome = btn.dataset.outcome;
        try {
          const data = await apiFetch('/api/message/outcome', {
            method: 'POST',
            body: JSON.stringify({ outcome }),
          });
          document.getElementById('messageMetaOutput').textContent = JSON.stringify(data, null, 2);
          await refreshStatus();
        } catch (error) {
          document.getElementById('messageMetaOutput').textContent = error.message;
        }
      });
    });

    document.getElementById('loadContextBtn').addEventListener('click', async () => {
      try {
        const data = await apiFetch('/api/context');
        document.getElementById('contextInput').value = data.context || '';
      } catch (error) {
        document.getElementById('contextInput').value = error.message;
      }
    });

    document.getElementById('saveContextBtn').addEventListener('click', async () => {
      const text = document.getElementById('contextInput').value;
      try {
        await apiFetch('/api/context', {
          method: 'POST',
          body: JSON.stringify({ text }),
        });
        setStatus('Context saved', 'ok');
      } catch (error) {
        setStatus(error.message, 'err');
      }
    });

    document.getElementById('resetContextBtn').addEventListener('click', async () => {
      try {
        const data = await apiFetch('/api/context/reset', { method: 'POST', body: '{}' });
        document.getElementById('contextInput').value = data.context || '';
      } catch (error) {
        document.getElementById('contextInput').value = error.message;
      }
    });

    document.getElementById('addNoteBtn').addEventListener('click', async () => {
      const text = document.getElementById('noteInput').value;
      try {
        await apiFetch('/api/notes', {
          method: 'POST',
          body: JSON.stringify({ text }),
        });
        document.getElementById('noteInput').value = '';
        await loadNotes();
      } catch (error) {
        document.getElementById('notesOutput').textContent = error.message;
      }
    });

    async function loadNotes() {
      try {
        const data = await apiFetch('/api/notes');
        document.getElementById('notesOutput').textContent = JSON.stringify(data, null, 2);
      } catch (error) {
        document.getElementById('notesOutput').textContent = error.message;
      }
    }

    document.getElementById('loadNotesBtn').addEventListener('click', loadNotes);

    document.getElementById('loadStatsBtn').addEventListener('click', async () => {
      const output = document.getElementById('statsOutput');
      try {
        const stats = await apiFetch('/api/stats');
        const gstats = await apiFetch('/api/gstats');
        const score = await apiFetch('/api/score');
        const gscore = await apiFetch('/api/gscore');
        const modes = await apiFetch('/api/modes');
        const gmodes = await apiFetch('/api/gmodes');
        output.textContent = JSON.stringify({ stats, gstats, score, gscore, modes, gmodes }, null, 2);
      } catch (error) {
        output.textContent = error.message;
      }
    });

    document.getElementById('resetStatsBtn').addEventListener('click', async () => {
      try {
        await apiFetch('/api/reset-stats', { method: 'POST', body: '{}' });
        document.getElementById('statsOutput').textContent = 'Stats reset.';
      } catch (error) {
        document.getElementById('statsOutput').textContent = error.message;
      }
    });

    document.getElementById('loadDataBtn').addEventListener('click', async () => {
      try {
        const data = await apiFetch('/api/data');
        document.getElementById('dataEditor').value = JSON.stringify(data, null, 2);
      } catch (error) {
        document.getElementById('dataEditor').value = error.message;
      }
    });

    document.getElementById('saveDataBtn').addEventListener('click', async () => {
      const text = document.getElementById('dataEditor').value;
      try {
        const payload = JSON.parse(text);
        await apiFetch('/api/data', {
          method: 'POST',
          body: JSON.stringify(payload),
        });
        document.getElementById('backupOutput').textContent = 'Data saved.';
      } catch (error) {
        document.getElementById('backupOutput').textContent = error.message;
      }
    });

    document.getElementById('exportDataBtn').addEventListener('click', () => {
      window.open('/api/export', '_blank');
    });

    document.getElementById('backupBtn').addEventListener('click', async () => {
      try {
        const data = await apiFetch('/api/backup', { method: 'POST', body: '{}' });
        document.getElementById('backupOutput').textContent = `Backup created: ${data.name}`;
      } catch (error) {
        document.getElementById('backupOutput').textContent = error.message;
      }
    });

    document.getElementById('saveSettingsBtn').addEventListener('click', async () => {
      const payload = {
        autopick: document.getElementById('autopickSelect').value === 'true',
        pacing: document.getElementById('pacingSelect').value,
        autoghostHours: Number(document.getElementById('autoghostInput').value),
        learning: document.getElementById('learningSelect').value === 'true',
        learnDebug: document.getElementById('learnDebugSelect').value === 'true',
      };
      try {
        const data = await apiFetch('/api/settings', {
          method: 'POST',
          body: JSON.stringify(payload),
        });
        document.getElementById('tuneOutput').textContent = JSON.stringify(data, null, 2);
        await refreshStatus();
      } catch (error) {
        document.getElementById('tuneOutput').textContent = error.message;
      }
    });

    document.getElementById('resetLearningBtn').addEventListener('click', async () => {
      try {
        const data = await apiFetch('/api/reset_learn', { method: 'POST', body: '{}' });
        document.getElementById('tuneOutput').textContent = JSON.stringify(data, null, 2);
      } catch (error) {
        document.getElementById('tuneOutput').textContent = error.message;
      }
    });

    document.getElementById('tuneBtn').addEventListener('click', async () => {
      const key = document.getElementById('tuneKeyInput').value.trim();
      const value = Number(document.getElementById('tuneValueInput').value);
      try {
        const data = await apiFetch('/api/tune', {
          method: 'POST',
          body: JSON.stringify({ key, value }),
        });
        document.getElementById('tuneOutput').textContent = JSON.stringify(data, null, 2);
      } catch (error) {
        document.getElementById('tuneOutput').textContent = error.message;
      }
    });

    document.getElementById('loadLogsBtn').addEventListener('click', loadLogs);

    async function loadLogs() {
      const lines = document.getElementById('logLinesInput').value || 200;
      try {
        const data = await apiFetch(`/api/logs?lines=${encodeURIComponent(lines)}`);
        document.getElementById('logsOut').textContent = (data.out || []).join('\n');
        document.getElementById('logsErr').textContent = (data.err || []).join('\n');
      } catch (error) {
        document.getElementById('logsOut').textContent = error.message;
        document.getElementById('logsErr').textContent = '';
      }
    }

    document.getElementById('chatSendBtn').addEventListener('click', async () => {
      const payload = {
        system: document.getElementById('chatSystemInput').value,
        message: document.getElementById('chatMessageInput').value,
        temperature: Number(document.getElementById('chatTempInput').value),
        max_output_tokens: Number(document.getElementById('chatTokensInput').value),
      };
      try {
        const data = await apiFetch('/api/chat', {
          method: 'POST',
          body: JSON.stringify(payload),
        });
        document.getElementById('chatOutput').textContent = JSON.stringify(data, null, 2);
      } catch (error) {
        document.getElementById('chatOutput').textContent = error.message;
      }
    });

    document.querySelectorAll('#tabNav button').forEach((btn) => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('#tabNav button').forEach((b) => b.classList.remove('active'));
        document.querySelectorAll('.tab').forEach((tab) => tab.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(`tab-${btn.dataset.tab}`).classList.add('active');
      });
    });

    savePrefs();
    updateRefreshTimer();
  </script>
</body>
</html>

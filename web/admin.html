<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DM Bot Admin</title>
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #0f1115;
        color: #e6e6e6;
      }
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 24px;
        border-bottom: 1px solid #222;
      }
      main {
        padding: 24px;
        display: grid;
        gap: 16px;
      }
      .grid {
        display: grid;
        gap: 16px;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      }
      .card {
        background: #171a23;
        border: 1px solid #222;
        border-radius: 10px;
        padding: 16px;
      }
      h2 {
        margin-top: 0;
      }
      label {
        font-size: 12px;
        opacity: 0.7;
      }
      input,
      select,
      textarea {
        width: 100%;
        padding: 8px;
        margin-top: 6px;
        background: #0f1115;
        border: 1px solid #333;
        color: #e6e6e6;
        border-radius: 6px;
      }
      textarea {
        min-height: 90px;
      }
      button {
        margin-top: 8px;
        padding: 10px 14px;
        background: #2b61ff;
        border: none;
        color: #fff;
        border-radius: 6px;
        cursor: pointer;
      }
      button[disabled] {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .status-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 8px;
        border-radius: 999px;
        background: #1b1f2a;
        font-size: 12px;
      }
      .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #999;
      }
      pre {
        background: #0f1115;
        border: 1px solid #333;
        padding: 12px;
        border-radius: 6px;
        max-height: 240px;
        overflow: auto;
      }
    </style>
  </head>
  <body>
    <header>
      <div>
        <strong>DM Bot Admin</strong>
        <span class="status-pill"><span id="botDot" class="dot"></span>Bot <span id="botStatus">OFF</span></span>
        <span class="status-pill">Learning <span id="learningStatus">OFF</span></span>
      </div>
      <div>
        <label>WEB_TOKEN</label>
        <input id="tokenInput" placeholder="x-web-token" />
      </div>
    </header>

    <main>
      <div class="card">
        <h2>Status</h2>
        <button id="refreshStatus">Обновить статус</button>
        <pre id="statusBox">—</pre>
      </div>

      <div class="card">
        <h2>Learning toggle</h2>
        <div class="row">
          <button id="learnOn">Learn ON</button>
          <button id="learnOff">Learn OFF</button>
          <button id="learnDebugOn">Debug ON</button>
          <button id="learnDebugOff">Debug OFF</button>
          <button id="resetLearn">Reset Learn</button>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <h2>Girls</h2>
          <select id="girlsList"></select>
          <div class="row">
            <button id="applyGirl">Выбрать активную</button>
            <button id="refreshGirls">/girls</button>
          </div>
        </div>
        <div class="card">
          <h2>Context</h2>
          <textarea id="contextText"></textarea>
          <div class="row">
            <button id="applyContext">Применить контекст</button>
            <button id="resetDialog">/reset</button>
          </div>
        </div>
        <div class="card">
          <h2>Notes</h2>
          <pre id="notesBox">—</pre>
          <textarea id="noteInput" placeholder="Новая заметка"></textarea>
          <button id="addNote">Добавить заметку</button>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <h2>Automation</h2>
          <div class="row">
            <button id="autopickOn">Autopick ON</button>
            <button id="autopickOff">Autopick OFF</button>
          </div>
          <div class="row">
            <input id="autoghostHours" placeholder="autoghost hours or off" />
            <button id="setAutoghost">Apply</button>
          </div>
          <div class="row">
            <button id="pacingWarm">Pacing warm</button>
            <button id="pacingFast">Pacing fast</button>
          </div>
        </div>
        <div class="card">
          <h2>Analytics / Plans</h2>
          <div class="row">
            <button id="btnAnalyze">/analyze</button>
            <button id="btnFlags">/flags</button>
            <button id="btnDateplan">/dateplan</button>
          </div>
        </div>
        <div class="card">
          <h2>Stats</h2>
          <div class="row">
            <button id="btnStats">/stats</button>
            <button id="btnGstats">/gstats</button>
            <button id="btnScore">/score</button>
            <button id="btnGscore">/gscore</button>
          </div>
        </div>
        <div class="card">
          <h2>Modes</h2>
          <div class="row">
            <button id="btnModes">/modes</button>
            <button id="btnGmodes">/gmodes</button>
          </div>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <h2>Messaging</h2>
          <textarea id="sentText" placeholder="/sent текст"></textarea>
          <button id="btnSent">/sent</button>
          <input id="reengageHours" placeholder="reengage hours (optional)" />
          <button id="btnReengage">/reengage</button>
        </div>
        <div class="card">
          <h2>Export / Backup</h2>
          <div class="row">
            <button id="btnExport">/export</button>
            <button id="btnBackup">/backup</button>
          </div>
          <input id="backupName" placeholder="backup filename" />
          <button id="btnDownloadBackup">Download backup</button>
        </div>
        <div class="card">
          <h2>Command Runner</h2>
          <input id="commandInput" placeholder="/girl Masha" />
          <button id="runCommand">Run</button>
        </div>
      </div>

      <div class="card">
        <h2>Output Log</h2>
        <pre id="logBox">—</pre>
      </div>
    </main>

    <script>
      const tokenInput = document.getElementById('tokenInput');
      tokenInput.value = localStorage.getItem('webToken') || '';
      tokenInput.addEventListener('input', () => {
        localStorage.setItem('webToken', tokenInput.value.trim());
      });

      const logBox = document.getElementById('logBox');
      const statusBox = document.getElementById('statusBox');
      const botStatus = document.getElementById('botStatus');
      const botDot = document.getElementById('botDot');
      const learningStatus = document.getElementById('learningStatus');

      function setLog(payload) {
        logBox.textContent = typeof payload === 'string' ? payload : JSON.stringify(payload, null, 2);
      }

      async function apiFetch(path, options = {}) {
        const token = localStorage.getItem('webToken') || '';
        const headers = options.headers || {};
        headers['x-web-token'] = token;
        headers['Content-Type'] = 'application/json';
        const res = await fetch(path, { ...options, headers });
        if (res.status === 401) {
          throw new Error('Неверный WEB_TOKEN');
        }
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          throw new Error(data.error || 'Request failed');
        }
        return res.json();
      }

      async function withButton(button, fn) {
        button.disabled = true;
        try {
          const result = await fn();
          setLog(result);
          return result;
        } catch (err) {
          setLog({ error: err.message });
          throw err;
        } finally {
          button.disabled = false;
        }
      }

      async function refreshStatus() {
        try {
          const data = await apiFetch('/api/status');
          statusBox.textContent = JSON.stringify(data, null, 2);
          botStatus.textContent = 'ON';
          botDot.style.background = '#2bff88';
          learningStatus.textContent = data.learning.enabled ? 'ON' : 'OFF';
          await refreshGirls();
          await refreshNotes();
          return data;
        } catch (err) {
          botStatus.textContent = 'OFF';
          botDot.style.background = '#ff5555';
          learningStatus.textContent = 'OFF';
          setLog({ error: err.message });
        }
      }

      async function refreshGirls() {
        const data = await apiFetch('/api/girls');
        const list = document.getElementById('girlsList');
        list.innerHTML = '';
        data.girls.forEach((name) => {
          const option = document.createElement('option');
          option.value = name;
          option.textContent = name;
          if (name === data.active) option.selected = true;
          list.appendChild(option);
        });
        const ctx = await apiFetch('/api/context');
        document.getElementById('contextText').value = ctx.context || '';
      }

      async function refreshNotes() {
        const res = await apiFetch('/api/command', { method: 'POST', body: JSON.stringify({ command: '/notes' }) });
        document.getElementById('notesBox').textContent = JSON.stringify(res.data || res, null, 2);
      }

      document.getElementById('refreshStatus').addEventListener('click', () =>
        withButton(document.getElementById('refreshStatus'), refreshStatus)
      );

      document.getElementById('learnOn').addEventListener('click', () =>
        withButton(document.getElementById('learnOn'), () => apiFetch('/api/command', { method: 'POST', body: JSON.stringify({ command: '/learn on' }) }))
      );
      document.getElementById('learnOff').addEventListener('click', () =>
        withButton(document.getElementById('learnOff'), () => apiFetch('/api/command', { method: 'POST', body: JSON.stringify({ command: '/learn off' }) }))
      );
      document.getElementById('learnDebugOn').addEventListener('click', () =>
        withButton(document.getElementById('learnDebugOn'), () => apiFetch('/api/command', { method: 'POST', body: JSON.stringify({ command: '/learn_debug on' }) }))
      );
      document.getElementById('learnDebugOff').addEventListener('click', () =>
        withButton(document.getElementById('learnDebugOff'), () => apiFetch('/api/command', { method: 'POST', body: JSON.stringify({ command: '/learn_debug off' }) }))
      );
      document.getElementById('resetLearn').addEventListener('click', () =>
        withButton(document.getElementById('resetLearn'), () => apiFetch('/api/command', { method: 'POST', body: JSON.stringify({ command: '/reset_learn' }) }))
      );

      document.getElementById('applyGirl').addEventListener('click', () =>
        withButton(document.getElementById('applyGirl'), async () => {
          const name = document.getElementById('girlsList').value;
          const res = await apiFetch('/api/command', { method: 'POST', body: JSON.stringify({ command: `/girl ${name}` }) });
          await refreshGirls();
          return res;
        })
      );
      document.getElementById('refreshGirls').addEventListener('click', () =>
        withButton(document.getElementById('refreshGirls'), () =>
          apiFetch('/api/command', { method: 'POST', body: JSON.stringify({ command: '/girls' }) })
        )
      );

      document.getElementById('applyContext').addEventListener('click', () =>
        withButton(document.getElementById('applyContext'), () => {
          const text = document.getElementById('contextText').value;
          return apiFetch('/api/command', { method: 'POST', body: JSON.stringify({ command: `/ctx ${text}` }) });
        })
      );
      document.getElementById('resetDialog').addEventListener('click', () =>
        withButton(document.getElementById('resetDialog'), () =>
          apiFetch('/api/command', { method: 'POST', body: JSON.stringify({ command: '/reset' }) })
        )
      );

      document.getElementById('addNote').addEventListener('click', () =>
        withButton(document.getElementById('addNote'), async () => {
          const note = document.getElementById('noteInput').value;
          const res = await apiFetch('/api/command', { method: 'POST', body: JSON.stringify({ command: `/note ${note}` }) });
          await refreshNotes();
          return res;
        })
      );

      document.getElementById('autopickOn').addEventListener('click', () =>
        withButton(document.getElementById('autopickOn'), () => apiFetch('/api/command', { method: 'POST', body: JSON.stringify({ command: '/autopick on' }) }))
      );
      document.getElementById('autopickOff').addEventListener('click', () =>
        withButton(document.getElementById('autopickOff'), () => apiFetch('/api/command', { method: 'POST', body: JSON.stringify({ command: '/autopick off' }) }))
      );
      document.getElementById('setAutoghost').addEventListener('click', () =>
        withButton(document.getElementById('setAutoghost'), () => {
          const hours = document.getElementById('autoghostHours').value.trim();
          const cmd = hours ? `/autoghost ${hours}` : '/autoghost';
          return apiFetch('/api/command', { method: 'POST', body: JSON.stringify({ command: cmd }) });
        })
      );
      document.getElementById('pacingWarm').addEventListener('click', () =>
        withButton(document.getElementById('pacingWarm'), () => apiFetch('/api/command', { method: 'POST', body: JSON.stringify({ command: '/pacing warm' }) }))
      );
      document.getElementById('pacingFast').addEventListener('click', () =>
        withButton(document.getElementById('pacingFast'), () => apiFetch('/api/command', { method: 'POST', body: JSON.stringify({ command: '/pacing fast' }) }))
      );

      document.getElementById('btnAnalyze').addEventListener('click', () =>
        withButton(document.getElementById('btnAnalyze'), () => apiFetch('/api/command', { method: 'POST', body: JSON.stringify({ command: '/analyze' }) }))
      );
      document.getElementById('btnFlags').addEventListener('click', () =>
        withButton(document.getElementById('btnFlags'), () => apiFetch('/api/command', { method: 'POST', body: JSON.stringify({ command: '/flags' }) }))
      );
      document.getElementById('btnDateplan').addEventListener('click', () =>
        withButton(document.getElementById('btnDateplan'), () => apiFetch('/api/command', { method: 'POST', body: JSON.stringify({ command: '/dateplan' }) }))
      );

      document.getElementById('btnStats').addEventListener('click', () =>
        withButton(document.getElementById('btnStats'), () => apiFetch('/api/command', { method: 'POST', body: JSON.stringify({ command: '/stats' }) }))
      );
      document.getElementById('btnGstats').addEventListener('click', () =>
        withButton(document.getElementById('btnGstats'), () => apiFetch('/api/command', { method: 'POST', body: JSON.stringify({ command: '/gstats' }) }))
      );
      document.getElementById('btnScore').addEventListener('click', () =>
        withButton(document.getElementById('btnScore'), () => apiFetch('/api/command', { method: 'POST', body: JSON.stringify({ command: '/score' }) }))
      );
      document.getElementById('btnGscore').addEventListener('click', () =>
        withButton(document.getElementById('btnGscore'), () => apiFetch('/api/command', { method: 'POST', body: JSON.stringify({ command: '/gscore' }) }))
      );

      document.getElementById('btnModes').addEventListener('click', () =>
        withButton(document.getElementById('btnModes'), () => apiFetch('/api/command', { method: 'POST', body: JSON.stringify({ command: '/modes' }) }))
      );
      document.getElementById('btnGmodes').addEventListener('click', () =>
        withButton(document.getElementById('btnGmodes'), () => apiFetch('/api/command', { method: 'POST', body: JSON.stringify({ command: '/gmodes' }) }))
      );

      document.getElementById('btnSent').addEventListener('click', () =>
        withButton(document.getElementById('btnSent'), () => {
          const text = document.getElementById('sentText').value;
          return apiFetch('/api/command', { method: 'POST', body: JSON.stringify({ command: `/sent ${text}` }) });
        })
      );
      document.getElementById('btnReengage').addEventListener('click', () =>
        withButton(document.getElementById('btnReengage'), () => {
          const hours = document.getElementById('reengageHours').value.trim();
          const cmd = hours ? `/reengage ${hours}` : '/reengage';
          return apiFetch('/api/command', { method: 'POST', body: JSON.stringify({ command: cmd }) });
        })
      );

      document.getElementById('btnExport').addEventListener('click', () =>
        withButton(document.getElementById('btnExport'), () => apiFetch('/api/export'))
      );
      document.getElementById('btnBackup').addEventListener('click', () =>
        withButton(document.getElementById('btnBackup'), () => apiFetch('/api/backup', { method: 'POST' }))
      );
      document.getElementById('btnDownloadBackup').addEventListener('click', async () => {
        const name = document.getElementById('backupName').value.trim();
        if (!name) return;
        const token = localStorage.getItem('webToken') || '';
        const res = await fetch(`/api/backup/${encodeURIComponent(name)}`, {
          headers: { 'x-web-token': token },
        });
        if (!res.ok) {
          setLog({ error: 'Backup not found' });
          return;
        }
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = name;
        link.click();
        URL.revokeObjectURL(url);
      });

      document.getElementById('runCommand').addEventListener('click', () =>
        withButton(document.getElementById('runCommand'), () => {
          const command = document.getElementById('commandInput').value.trim();
          return apiFetch('/api/command', { method: 'POST', body: JSON.stringify({ command }) });
        })
      );

      refreshStatus();
      setInterval(refreshStatus, 5000);
    </script>
  </body>
</html>
